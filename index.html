<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Media Merger</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.10.1"></script>
</head>
<body>
    <div class="container mt-5">
        <div class="row mb-3">
            <div class="col">
                <input type="file" class="form-control" id="fileInput" multiple>
            </div>
            <div class="col">
                <select class="form-select" id="resolutionSelect">
                    <option value="480">480p</option>
                    <option value="720">720p</option>
                    <option value="1080">1080p</option>
                </select>
            </div>
            <div class="col">
                <button class="btn btn-primary" id="downloadBtn">Download Merged Video</button>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div id="cardContainer" class="d-flex flex-wrap"></div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <video id="my-video" class="video-js w-100" controls preload="auto" poster="" data-setup='' loop>
                    <source src="" type='video/mp4'>
                </video>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            const fileInput = $('#fileInput');
            const cardContainer = $('#cardContainer');
            const downloadBtn = $('#downloadBtn');
            const resolutionSelect = $('#resolutionSelect');
            const videoElement = $('#my-video');

            const tracks = [];

            fileInput.on('change', function(e) {
                const files = e.target.files;
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileType = file.type;

                    if (fileType.startsWith('video/')) {
                        handleVideoFile(file);
                    } else if (fileType.startsWith('audio/')) {
                        handleAudioFile(file);
                    } else if (fileType.startsWith('image/')) {
                        handleImageFile(file);
                    }
                }
            });

            function handleVideoFile(file) {
                const url = URL.createObjectURL(file);
                const videoSource = videoElement.find('source');
                videoSource.attr('src', url);
                videoElement[0].load();

                const card = createCard('Video', url, 'https://via.placeholder.com/150');
                cardContainer.append(card);

                tracks.push({ type: 'video', file });
            }

            function handleAudioFile(file) {
                const url = URL.createObjectURL(file);
                const audioElement = $('<audio></audio>').attr({
                    src: url,
                    controls: true,
                    class: 'w-100'
                });

                const card = createCard('Audio', url, 'https://via.placeholder.com/150');
                card.append(audioElement);
                cardContainer.append(card);

                tracks.push({ type: 'audio', file });
            }

            function handleImageFile(file) {
                const url = URL.createObjectURL(file);
                const imgElement = $('<img>').attr({
                    src: url,
                    class: 'img-fluid'
                });

                const card = createCard('Image', url, url);
                card.append(imgElement);
                cardContainer.append(card);

                tracks.push({ type: 'image', file });
            }

            function createCard(title, url, thumbnail) {
                const card = $('<div></div>').addClass('card m-2').attr('draggable', true).css({ width: '150px' });
                const img = $('<img>').attr('src', thumbnail).addClass('card-img-top');
                const cardBody = $('<div></div>').addClass('card-body p-2');
                const cardTitle = $('<h6></h6>').addClass('card-title text-truncate').text(title);

                cardBody.append(cardTitle);
                card.append(img).append(cardBody);
                card.on('click', function() {
                    window.open(url, '_blank');
                });

                return card;
            }

            downloadBtn.on('click', async function() {
                try {
                    const resolution = resolutionSelect.val();
                    const { createFFmpeg, fetchFile } = FFmpeg;
                    const ffmpeg = createFFmpeg({ log: true });
                    await ffmpeg.load();

                    for (const track of tracks) {
                        await ffmpeg.FS('writeFile', track.file.name, await fetchFile(track.file));
                    }

                    const videoInputs = tracks.filter(track => track.type === 'video').map((track, index) => `[${index}:v]scale=-1:${resolution},setsar=1:1[v${index}]`).join('; ');
                    const imageInputs = tracks.filter(track => track.type === 'image').map((track, index) => `[${index + tracks.filter(t => t.type === 'video').length}:v]scale=-1:${resolution},setsar=1:1[v${index + tracks.filter(t => t.type === 'video').length}]`).join('; ');
                    const audioInputs = tracks.filter(track => track.type === 'audio').map((track, index) => `[${index + tracks.filter(t => t.type === 'video' || t.type === 'image').length}:a]`).join('; ');

                    const filterComplex = `${videoInputs}; ${imageInputs}; ${audioInputs}`;

                    const inputs = tracks.map(track => `-i ${track.file.name}`).join(' ');

                    const command = `-filter_complex "${filterComplex}" -map "[v0]" -map "[a0]" output.mp4`;

                    await ffmpeg.run(...inputs.split(' '), ...command.split(' '));
                    const data = await ffmpeg.FS('readFile', 'output.mp4');
                    const blob = new Blob([data.buffer], { type: 'video/mp4' });
                    const videoUrl = URL.createObjectURL(blob);

                    videoElement.attr('src', videoUrl).attr('controls', true);

                    const downloadLink = $('<a></a>').attr({
                        href: videoUrl,
                        download: 'merged_video.mp4',
                        class: 'btn btn-success mt-3'
                    }).text('Download');
                    cardContainer.append(downloadLink);
                } catch (error) {
                    console.error(error);
                    alert("An error occurred while generating the video.");
                }
            });
        });
    </script>
</body>
</html>
